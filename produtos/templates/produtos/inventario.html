<!DOCTYPE html>
{% load humanize %}
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meu Inventário</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8f9fa;
      }
      .navbar {
        background-color: #1a237e;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .navbar-brand {
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      .card-item {
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        background-color: #343a40;
        position: relative;
        overflow: hidden;
        min-height: 420px;
      }
      .card-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .card-overlay {
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0),
          rgba(0, 0, 0, 0.5)
        );
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
      }
      .card-item .card-body {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        height: 100%;
        color: white;
      }
      .section-title {
        border-left: 5px solid #1a237e;
        padding-left: 15px;
        margin-bottom: 20px;
        color: #333;
      }
      .bg-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        z-index: 0;
      }
      .bg-fallback {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #2c3e50, #4ca1af);
        z-index: 0;
      }
      .text-shadow {
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
      <div class="container">
        <a class="navbar-brand" href="{% url 'mercado' %}"
          ><i class="fas fa-shopping-cart me-2"></i>MarketRO</a
        >
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item me-3">
              <span class="badge bg-light text-dark p-2 shadow-sm"
                ><i class="fas fa-wallet me-1 text-success"></i> R$
                {{user.perfil.saldo|intcomma}}</span
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'mercado' %}"
                ><i class="fas fa-store me-1"></i> Mercado</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="{% url 'inventario' %}"
                ><i class="fas fa-backpack me-1"></i> Inventário</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'historico' %}"
                ><i class="fas fa-history me-1"></i> Histórico</a
              >
            </li>
            <li class="nav-item ms-2">
              <form
                action="{% url 'logout' %}?next={% url 'login' %}"
                method="post"
                class="d-inline"
              >
                {% csrf_token %}<button
                  type="submit"
                  class="btn btn-outline-danger btn-sm rounded-pill"
                >
                  <i class="fas fa-sign-out-alt"></i>
                </button>
              </form>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
    <div class="container mt-4">
      {% for message in messages %}
      <div
        class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %} alert-dismissible fade show shadow-sm"
        role="alert"
      >
        {% if message.tags == 'error' %}<i
          class="fas fa-exclamation-circle me-2"
        ></i
        >{% else %}<i class="fas fa-check-circle me-2"></i>{% endif %}
        {{message}}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="container py-5">
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex align-items-center">
            <div
              class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3"
              style="width: 60px; height: 60px"
            >
              <i class="fas fa-backpack fa-2x"></i>
            </div>
            <div>
              <h1 class="h3 fw-bold mb-0">Mochila de {{ user.username }}</h1>
              <p class="text-muted mb-0">Gerencie seus itens e vendas</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtros de Categoria -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="d-flex gap-2 overflow-auto pb-2">
            <a
              href="{% url 'inventario' %}"
              class="btn btn-outline-primary rounded-pill {% if not request.resolver_match.kwargs.slug %}active{% endif %}"
            >
              Todos
            </a>
            {% for cat in categorias %}
            <a
              href="{% url 'inventario_por_categoria' cat.slug %}"
              class="btn btn-outline-primary rounded-pill {% if request.resolver_match.kwargs.slug == cat.slug %}active{% endif %}"
            >
              {% if cat.icone %}<i class="{{ cat.icone }} me-1"></i>{% endif %}
              {{ cat.nome }}
            </a>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Itens no Mercado -->
      <div class="mb-5">
        <h3 class="section-title">
          <i class="fas fa-store me-2 text-primary"></i>Itens no Mercado
        </h3>
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
          {% for produto in itens_mercado %}
          <div class="col">
            <div class="card card-item shadow-sm h-100 border-success border-2">
              {% if produto.imagem %}
              <div
                class="bg-image"
                style="background-image: url('{{ produto.imagem.url }}');"
              ></div>
              {% else %}
              <div class="bg-fallback"></div>
              {% endif %}

              <div class="card-overlay"></div>

              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-start mb-2"
                >
                  <h5 class="card-title fw-bold text-white text-shadow">
                    <i class="fas {{ produto.get_icone_class }} me-2"></i
                    >{{produto.nome }}
                  </h5>
                  <span class="badge bg-success shadow">À Venda</span>
                </div>

                <h6 class="text-white fw-bold mb-3 fs-5">
                  R$ {{ produto.preco|intcomma }}
                </h6>

                <div class="small text-white-50 mb-3">
                  <p class="mb-1">
                    <i class="far fa-clock me-1"></i>
                    {{produto.publicado_em|date:"d/m H:i" }}
                  </p>
                  <p class="mb-0">
                    <i class="far fa-eye me-1"></i> {{ produto.visualizacoes }}
                    views
                  </p>
                </div>

                <hr class="border-light opacity-50" />

                <form
                  action="{% url 'toggle_venda' produto.id %}"
                  method="post"
                >
                  {% csrf_token %}
                  <input
                    type="hidden"
                    name="preco_venda"
                    value="{{ produto.preco }}"
                  />
                  <button
                    type="submit"
                    class="btn btn-outline-danger w-100 btn-sm fw-bold"
                  >
                    <i class="fas fa-times me-1"></i> Remover
                  </button>
                </form>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="col-12">
            <div class="alert alert-light border shadow-sm" role="alert">
              <i class="fas fa-info-circle me-2 text-primary"></i> Você não tem
              itens à venda no momento.
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Meu Inventário -->
      <div>
        <h3 class="section-title" style="border-color: #6c757d">
          <i class="fas fa-box me-2 text-secondary"></i>Meu Inventário
        </h3>
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
          {% for produto in itens_inventario %}
          <div class="col">
            <div class="card card-item shadow-sm h-100">
              {% if produto.imagem %}
              <div
                class="bg-image"
                style="background-image: url('{{ produto.imagem.url }}');"
              ></div>
              {% else %}
              <div class="bg-fallback"></div>
              {% endif %}

              <div class="card-overlay"></div>

              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-start mb-2"
                >
                  <h5 class="card-title fw-bold text-white text-shadow">
                    <i class="fas {{ produto.get_icone_class }} me-2"></i
                    >{{produto.nome }}
                  </h5>
                  <span class="badge bg-secondary shadow">Privado</span>
                </div>

                <hr class="border-light opacity-50" />

                <form
                  action="{% url 'toggle_venda' produto.id %}"
                  method="post"
                >
                  {% csrf_token %}
                  <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text bg-dark text-white border-0"
                      >R$</span
                    >
                    <input
                      type="number"
                      name="preco_venda"
                      step="0.01"
                      class="form-control bg-dark text-white border-secondary"
                      placeholder="Valor..."
                      required
                    />
                  </div>
                  <button
                    type="submit"
                    class="btn btn-warning w-100 btn-sm text-dark fw-bold shadow-sm"
                  >
                    <i class="fas fa-tag me-1"></i> Vender
                  </button>
                </form>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="col-12">
            <div class="alert alert-light border shadow-sm" role="alert">
              <i class="fas fa-ghost me-2 text-secondary"></i> Sua mochila está
              vazia. Compre algo no mercado!
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
